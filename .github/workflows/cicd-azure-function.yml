name: CICD Build and release pipeline for (Development, Test, Production)
on:
  push:
    branches:
      - develop
  pull_request_review:
    types:
      - submitted

  workflow_dispatch:

env:
  SKIP_TST_RELEASE: ${{ vars.SKIP_TST_RELEASE || 'true' }}
  SKIP_PRD_RELEASE: ${{ vars.SKIP_PRD_RELEASE || 'true' }}

defaults:
  run:
    shell: bash

jobs:

  unit-test:
    uses: ./.github/workflows/test-azure-function.yml
    with:
      KUI_SOLUTION: HttpPostExperiment.sln
      KUI_SOLUTION_BUILD_CONFIGURATION: Release
      environment: Development
    secrets: inherit

  build:
    needs: unit-test
    uses: ./.github/workflows/build-azure-function.yml
    with:
      KUI_ARTIFACT_ZIP_NAME: http-post-exp-fa-package
      environment: Development

  release-dev:
    needs: build
    uses: ./.github/workflows/release-azure-function-dev.yml
    with:
      KUI_ARTIFACT_ZIP_NAME: http-post-exp-fa-package
      environment: Development
    secrets: inherit

  release-tst-skip-check:
    if: ${{ vars.KUI_SKIP_TST_RELEASE != 'false' }}
    needs: release-dev
    runs-on: ubuntu-latest
    steps:
      - name: Check for Skipping TST
        run: |
          echo "TST release check KUI_SKIP_TST_RELEASE: ${{ vars.KUI_SKIP_TST_RELEASE }}"

  approval-gate-tst:
    if: ${{ vars.KUI_SKIP_TST_RELEASE == 'false' }}
    needs: release-dev
    environment: Test
    runs-on: ubuntu-latest
    steps:
      - name: approved
        run: echo "Approve for Test"

  release-tst:
    if: ${{ vars.KUI_SKIP_TST_RELEASE == 'false' }}
    needs: approval-gate-tst
    uses: ./.github/workflows/release-azure-function-tst.yml
    with:
      KUI_ARTIFACT_ZIP_NAME: http-post-exp-fa-package
      environment: Test
    secrets: inherit

  release-prd-skip-check:
    if: ${{ vars.KUI_SKIP_PRD_RELEASE != 'false' }}
    needs: release-tst
    runs-on: ubuntu-latest
    steps:
      - name: Check for Skipping PRD
        run: |
          echo "PRD release check KUI_SKIP_PRD_RELEASE: ${{ vars.KUI_SKIP_PRD_RELEASE }}"

  approval-gate-prod:
    if: ${{ vars.KUI_SKIP_PRD_RELEASE == 'false' }}
    needs: release-tst
    environment: Production
    runs-on: ubuntu-latest
    steps:
      - name: approved
        run: echo "Approve for Production"

  release-prd:
    if: ${{ vars.KUI_SKIP_PRD_RELEASE == 'false' }}
    needs: approval-gate-prod
    uses: ./.github/workflows/release-azure-function-prd.yml
    with:
      KUI_ARTIFACT_ZIP_NAME: http-post-exp-fa-package
      environment: Production
    secrets: inherit
