name: CI/CD Build and release pipeline for (Development, Test, Production)

on:
  push:
    branches:
      - develop
      - main
  pull_request_review:
    types:
      - submitted
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:

  init-vars:
    runs-on: ubuntu-latest
    outputs:
      SKIP_RELEASES: ${{ steps.set-vars.outputs.SKIP_RELEASES }}
      SKIP_TST_RELEASE: ${{ steps.set-vars.outputs.SKIP_TST_RELEASE }}
      SKIP_PRD_RELEASE: ${{ steps.set-vars.outputs.SKIP_PRD_RELEASE }}
      PR_DEVELOP: ${{ steps.set-vars.outputs.PR_DEVELOP }}
      PR_MAIN: ${{ steps.set-vars.outputs.PR_MAIN }}
    steps:
      - id: set-vars
        run: |
          echo "Setting pipeline variables"
          # echo "SKIP_RELEASES=${{ github.event_name == 'push' && 'true' || 'false' }}" >> $GITHUB_OUTPUT
          # echo "SKIP_TST_RELEASE=${{ vars.SKIP_TST_RELEASE || 'true' }}" >> $GITHUB_OUTPUT
          # echo "SKIP_PRD_RELEASE=${{ vars.SKIP_PRD_RELEASE || 'true' }}" >> $GITHUB_OUTPUT
          # echo "PR_DEVELOP=${{ github.event_name == 'pull_request_review' && github.event.pull_request.base.ref == 'develop' && 'true' }}" >> $GITHUB_OUTPUT
          # echo "PR_MAIN=${{ github.event_name == 'pull_request_review' && github.event.pull_request.base.ref == 'main' && 'true' }}" >> $GITHUB_OUTPUT
          echo "SKIP_RELEASES=false" >> $GITHUB_OUTPUT
          echo "SKIP_TST_RELEASE=false" >> $GITHUB_OUTPUT
          echo "SKIP_PRD_RELEASE=false" >> $GITHUB_OUTPUT
          echo "PR_DEVELOP=true" >> $GITHUB_OUTPUT
          echo "PR_MAIN=false" >> $GITHUB_OUTPUT

  check-settings:
    needs: [init-vars]
    runs-on: ubuntu-latest
    steps:
      - name: Check pre-execution settings
        run: |
          echo "Checking pipeline variables"
          echo "SKIP_RELEASES: ${{ needs.init-vars.outputs.SKIP_RELEASES }}"
          echo "SKIP_TST_RELEASE: ${{ needs.init-vars.outputs.SKIP_TST_RELEASE }}"
          echo "SKIP_PRD_RELEASE: ${{ needs.init-vars.outputs.SKIP_PRD_RELEASE }}"
          echo "PR_DEVELOP: ${{ needs.init-vars.outputs.PR_DEVELOP }}"
          echo "PR_MAIN: ${{ needs.init-vars.outputs.PR_MAIN }}"

  unit-test:
    needs: [check-settings]
    runs-on: ubuntu-latest
    steps:
      - name: Settings
        run: |
          echo "unit-test stage - add your steps here"

  build:
    needs: [unit-test]
    runs-on: ubuntu-latest
    steps:
      - name: Settings
        run: |
          echo "build stage - add your steps here"

  skip-releases:
    needs: [build, init-vars]
    if: ${{ needs.init-vars.outputs.SKIP_RELEASES != 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Settings
        run: |
          echo "skip-releases stage - add your steps here"

  release-dev:
    needs: [build, init-vars]
    if: ${{ needs.init-vars.outputs.SKIP_RELEASES == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Settings
        run: |
          echo "build stage - add your steps here"

  skip-release-tst:
    needs: [release-dev, init-vars]
    if: ${{ needs.init-vars.outputs.SKIP_TST_RELEASE != 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check for Skipping PRD
        run: |
          echo "TST release check SKIP_TST_RELEASE: ${{ needs.init-vars.outputs.SKIP_TST_RELEASE }}"

  approval-gate-tst:
    needs: [release-dev, init-vars]
    if: ${{ needs.init-vars.outputs.SKIP_TST_RELEASE == 'false' }}
    environment: Test
    runs-on: ubuntu-latest
    steps:
      - name: approved
        run: echo "Approve for Test"

  release-tst:
    needs: [approval-gate-tst, init-vars]
    if: ${{ needs.init-vars.outputs.SKIP_TST_RELEASE == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Settings
        run: |
          echo "release-tst stage - add your steps here"

  skip-release-prd:
    needs: [release-tst, init-vars]
    if: ${{ needs.init-vars.outputs.SKIP_PRD_RELEASE != 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check for Skipping PRD
        run: |
          echo "PRD release check SKIP_PRD_RELEASE: ${{ needs.init-vars.outputs.SKIP_PRD_RELEASE }}"

  approval-gate-prod:
    needs: [release-tst, init-vars]
    if: ${{ needs.init-vars.outputs.SKIP_PRD_RELEASE == 'false' }}
    environment: Production
    runs-on: ubuntu-latest
    steps:
      - name: approved
        run: echo "Approve for Production"

  release-prd:
    needs: [approval-gate-prod, init-vars]
    if: ${{ needs.init-vars.outputs.SKIP_PRD_RELEASE == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Settings
        run: |
          echo "release-prd stage - add your steps here"
